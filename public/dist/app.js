angular.module("userApp",["ngAnimate","app.routes","authService","mainCtrl","userCtrl","chimeCtrl","interestedUserCtrl","userService","chimeService","interestedUserService","customFilters","ui.bootstrap"]).config(["$httpProvider",function(e){e.interceptors.push("AuthInterceptor")}]),angular.module("app.routes",["ngRoute"]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/views/pages/home.html",controller:"mainController",controllerAs:"main"}).when("/login",{templateUrl:"app/views/pages/login.html",controller:"mainController",controllerAs:"login"}).when("/users",{templateUrl:"app/views/pages/users/all.html",controller:"userController",controllerAs:"user"}).when("/users/create",{templateUrl:"app/views/pages/users/single.html",controller:"userCreateController",controllerAs:"user"}).when("/users/:user_id",{templateUrl:"app/views/pages/users/single.html",controller:"userEditController",controllerAs:"user"}).when("/chimes",{templateUrl:"app/views/pages/chimes/all.html",controller:"chimeController",controllerAs:"chime"}).when("/chimes/create",{templateUrl:"app/views/pages/chimes/single.html",controller:"chimeCreateController",controllerAs:"chime"}).when("/chimes/:chime_id",{templateUrl:"app/views/pages/chimes/single.html",controller:"chimeEditController",controllerAs:"chime"}).when("/interested_users",{templateUrl:"app/views/pages/interested_users/all.html",controller:"interestedUserController",controllerAs:"interestedUser"}).when("/interested_users/create",{templateUrl:"app/views/pages/interested_users/single.html",controller:"interestedUserCreateController",controllerAs:"interestedUser"}).when("/interested_users/:interested_user_id",{templateUrl:"app/views/pages/interested_users/single.html",controller:"interestedUserEditController",controllerAs:"interestedUser"}),t.html5Mode(!0)}]),angular.module("chimeCtrl",["chimeService","soundCloudService"]).controller("chimeController",["Chime","SoundCloud","$sce","$scope","$q","$timeout",function(e,t,r,i,n,s){var c=this;c.processing=!0,e.all().success(function(e){c.processing=!1,c.chimes=e}),c.playChime=function(e){var s=n.defer();return t.playTrack(e.url).then(function(e){c.soundCloudWidget=r.trustAsHtml(e.html),i.$apply(),c.iframe=document.getElementById("soundcloud_chime_widget").querySelector("iframe"),c.widget=t.getSC().Widget(c.iframe),s.resolve()}),s.promise},c.playFromStartTime=function(e){c.playChime(e).then(function(){c.widget.bind("play",function(){c.widget.seekTo(e.startTime)}),c.widget.bind("playProgress",function(t){t.currentPosition>=e.endTime&&c.widget.pause()})})},c.getLeftOffset=function(e){var t=angular.element(document.getElementById("waveform-container-cell"))[0].offsetWidth;console.log(angular.element(document.getElementById("waveform-container-cell"))[0].offsetWidth),console.log(t);var r=e.startTime/e.duration*t;return console.log(r),r},c.getChimeWidth=function(e){var t=angular.element(document.getElementById("waveform-container-cell"))[0].offsetWidth;console.log(angular.element(document.getElementById("waveform-container-cell"))[0].offsetWidth),console.log("width:",t);var r=(e.endTime-e.startTime)*t/e.duration;return r},c.deleteChime=function(t){c.processing=!0,e["delete"](t).success(function(t){e.all().success(function(e){c.processing=!1,c.chimes=e})})}}]).controller("chimeCreateController",["Chime","$scope","$location",function(e,t,r){var i=this;i.type="create",i.processing=!1,i.splicer={},i.musicProviders=[{name:"SoundCloud",icon:"fa-soundcloud",value:"soundCloud"},{name:"Spotify",icon:"fa-spotify",value:"spotify"},{name:"Google Play",icon:"fa-play",value:"googlePlay"},{name:"Apple Music",icon:"fa-apple",value:"appleMusic"},{name:"YouTube",icon:"fa-youtube-play",value:"youTube"}],i.currentMusicProvider=i.musicProviders[0],t.filterByName=function(e){return function(t){return t.name!=e}},i.setMusicProvider=function(e){i.currentMusicProvider=e},i.saveChime=function(){var t={title:i.chimeData.title,artist:i.chimeData.artist,url:i.chimeData.url,description:i.chimeData.description,genre:i.chimeData.genre,tags:i.chimeData.tags,artwork:i.chimeData.artwork,waveform:i.chimeData.waveform,startTime:i.splicer.startTime,endTime:i.splicer.endTime,duration:i.selectedTrack.duration};i.processing=!0,e.create(t).success(function(e){i.processing=!1,i.chimeData={},i.cleanUp(),r.path("/chimes")})}}]).controller("chimeEditController",["$routeParams","$scope","Chime",function(e,t,r){var i=this;i.type="update",r.get(e.chime_id).success(function(e){console.log(e),i.chimeData=e,i.selectedTrack=!0,i.splicer={startTime:i.chimeData.startTime,endTime:i.chimeData.endTime,duration:i.chimeData.duration,startTimeLocked:!0,endTimeLocked:!0},console.log(i.splicer),i.playTrack(i.chimeData).then(function(){i.lockEndTime(),i.setSliderOffsets(),i.bindWidgetActions()})}),i.saveChime=function(){i.processing=!0,i.message="",r.update(e.chime_id,i.chimeData).success(function(e){i.processing=!1,i.chimeData={},i.message=e.message})}}]).directive("soundCloudSongSearch",["SoundCloud","$sce",function(e,t){return{restrict:"E",scope:{chime:"="},templateUrl:"app/views/pages/chimes/soundCloudSongSearch.html",link:function(t,r,i){t.soundCloud={},t.soundCloudSearchInput="",t.searchTracks=function(r){e.searchTracks(r).then(function(e){console.log("Search results: ",e),t.soundCloud.tracks=e,t.$apply()},function(e){console.log("No tracks found matching that search term: ",e)})},t.authenticateSoundCloud=function(){e.authenticate()}}}}]).directive("chimeSplicer",["SoundCloud","$q","$sce","$window","$location",function(e,t,r,i,n){return{restrict:"E",scope:{chime:"="},templateUrl:"app/views/pages/chimes/chimeSplicer.html",link:function(s,c,o){s.chime.lockStartTime=function(){s.chime.splicer.startTimeLocked=!0,s.chime.splicer.endTime=s.chime.splicer.startTime,s.chime.setSliderOffsets()},s.chime.clearStartTime=function(){s.chime.splicer.startTimeLocked=!1,s.chime.splicer.endTimeLocked=!1,s.chime.splicer.startTime=0,s.chime.splicer.endTime=0,s.chime.splicer.leftOffset=0},s.chime.adjustStartTime=function(e){s.chime.splicer.startTimeLocked||-1===e||(s.chime.splicer.startTime=e,s.chime.setSliderOffsets(),s.$apply())},s.chime.setStartTime=function(){s.chime.widget.getPosition(function(e){s.chime.splicer.startTime=e,s.chime.setSliderOffsets(),s.$apply()})},s.chime.setEndTime=function(){s.chime.splicer.endTimeLocked||(s.chime.widget.pause(),s.chime.widget.getPosition(function(e){s.chime.splicer.endTime=e,s.chime.setSliderOffsets(),s.$apply()}))},s.chime.lockEndTime=function(){s.chime.splicer.endTimeLocked=!0;var e=+s.chime.splicer.startTime,t=+s.chime.splicer.endTime,r=s.chime.selectedTrack.duration,i=angular.element(document.getElementById("slider-container"))[0].clientWidth;s.chime.splicer.chimeWidth=(t-e)*i/r,s.chime.widget.bind("playProgress",function(e){e.currentPosition>=s.chime.splicer.endTime&&s.chime.widget.pause()})},s.chime.clearEndTime=function(){s.chime.widget.unbind("playProgress"),s.chime.splicer.endTimeLocked=!1,s.chime.splicer.endTime=s.chime.splicer.startTime,s.chime.splicer.chimeWidth=0},s.chime.setSliderOffsets=function(){var e=+s.chime.splicer.startTime,t=+s.chime.splicer.endTime,r=+s.chime.chimeData.duration,i=angular.element(document.getElementById("slider-container"))[0].clientWidth;s.chime.splicer.leftOffset=e/r*i,s.chime.splicer.widthOffset=i-s.chime.splicer.leftOffset,s.chime.splicer.chimeWidth=(t-e)*i/r},s.chime.playTrack=function(i){var n=t.defer(),c=i.permalink_url||i.url;return e.playTrack(c).then(function(t){console.log("oEmbed response: ",t),s.chime.streamingTrack=i,s.chime.soundCloudWidget=r.trustAsHtml(t.html),s.$apply(),s.chime.iframe=document.getElementById("soundcloud_widget").querySelector("iframe"),s.chime.widget=e.getSC().Widget(s.chime.iframe),n.resolve()}),n.promise},s.chime.playTrackSection=function(){s.chime.widget.seekTo(s.chime.splicer.startTime),s.chime.widget.isPaused(function(e){e&&s.chime.widget.play()})},s.chime.selectTrack=function(e){s.chime.selectedTrack=e,s.chime.chimeData={},s.chime.chimeData.title=e.title,s.chime.chimeData.artist=e.user.username,s.chime.chimeData.description=e.description,s.chime.chimeData.genre=e.genre,s.chime.chimeData.tags=e.tag_list,s.chime.chimeData.url=e.permalink_url,s.chime.chimeData.artwork=e.artwork_url||e.user.avatar_url,s.chime.chimeData.waveform=e.waveform_url,s.chime.chimeData.duration=e.duration,e!==s.chime.streamingTrack?s.chime.playTrack(e).then(function(){s.chime.bindWidgetActions()}):s.chime.bindWidgetActions(),angular.element(i).bind("resize",function(e){s.chime.setSliderOffsets(),s.$apply()})},s.chime.cleanUp=function(){delete s.chime.splicer,s.chime.widget&&(s.chime.widget.unbind("seek"),s.chime.widget.unbind("play"),s.chime.widget.unbind("pause")),angular.element(i)&&angular.element(i).unbind("resize"),"create"==s.chime.type?delete s.chime.selectedTrack:n.path("/chimes")},s.chime.bindWidgetActions=function(){s.chime.widget.bind("seek",function(e){s.chime.adjustStartTime(e.currentPosition)}),s.chime.widget.bind("play",function(){s.chime.showEndTimeSetter=!0,s.$apply()}),s.chime.widget.bind("pause",function(){s.chime.showEndTimeSetter=!1,s.$apply()})},s.$on("$destroy",function(){s.chime.cleanUp()})}}}]).directive("spotifySongSearch",["$sce",function(e){return{restrict:"E",scope:{chime:"="},templateUrl:"app/views/pages/chimes/spotifySongSearch.html",link:function(e,t,r){e.spotify={},e.spotifySearchInput=""}}}]),angular.module("interestedUserCtrl",["interestedUserService"]).controller("interestedUserController",["InterestedUser",function(e){var t=this;t.processing=!0,e.all().success(function(e){t.processing=!1,t.interestedUsers=e}),t.deleteInterestedUser=function(r){t.processing=!0,e["delete"](r).success(function(r){e.all().success(function(e){t.processing=!1,t.interestedUsers=e})})}}]).controller("interestedUserCreateController",["InterestedUser",function(e){var t=this;t.type="create",t.saveInterestedUser=function(){t.processing=!0,t.message="",e.create(t.interestedUserData).success(function(e){t.processing=!1,t.interestedUserData={},t.message=e.message})}}]).controller("interestedUserEditController",["$routeParams","InterestedUser",function(e,t){var r=this;r.type="update",t.get(e.interested_user_id).success(function(e){r.interestedUserData=e}),r.saveInterestedUser=function(){r.processing=!0,r.message="",t.update(e.interested_user_id,r.interestedUserData).success(function(e){r.processing=!1,r.interestedUserData={},r.message=e.message})}}]),angular.module("mainCtrl",[]).controller("mainController",["$rootScope","$location","Auth","InterestedUser",function(e,t,r,i){var n=this;n.loggedIn=r.isLoggedIn(),e.$on("$routeChangeStart",function(){n.loggedIn=r.isLoggedIn(),r.getUser().then(function(e){n.user=e.data})}),n.doLogin=function(){n.processing=!0,n.error="",r.login(n.loginData.username,n.loginData.password).success(function(e){n.processing=!1,e.success?t.path("/users"):n.error=e.message})},n.doLogout=function(){r.logout(),n.user="",t.path("/login")},n.doSignUp=function(){return console.log("signing up..."),console.log(n.interestedUser),console.log(n.interestedUser.name),i.create(n.interestedUser).success(function(e){console.log("here"),console.log(e),n.interestedUser={}}),n.hideSignUp=!0,!0}}]),angular.module("userCtrl",["userService"]).controller("userController",["User",function(e){var t=this;t.processing=!0,e.all().success(function(e){t.processing=!1,t.users=e}),t.deleteUser=function(r){t.processing=!0,e["delete"](r).success(function(r){e.all().success(function(e){t.processing=!1,t.users=e})})}}]).controller("userCreateController",["User",function(e){var t=this;t.type="create",t.saveUser=function(){t.processing=!0,t.message="",e.create(t.userData).success(function(e){t.processing=!1,t.userData={},t.message=e.message})}}]).controller("userEditController",["$routeParams","User",function(e,t){var r=this;r.type="edit",t.get(e.user_id).success(function(e){r.userData=e}),r.saveUser=function(){r.processing=!0,r.message="",t.update(e.user_id,r.userData).success(function(e){r.processing=!1,r.userData={},r.message=e.message})}}]),angular.module("customFilters",[]).filter("titleize",function(){return function(e){return e?(e=e.replace(/-/g," "),e=e.replace(/_/g," "),e=e.replace(/([a-z])([A-Z])/g,function(e,t,r){return t+" "+r}),e=e.replace(/(\s)([a-z])/g,function(e,t,r){return t+r.toUpperCase()}),e=e.replace(/([A-Z]{2,})/g,function(e,t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}),e=e.charAt(0).toUpperCase()+e.slice(1)):""}}),angular.module("authService",[]).factory("Auth",["$http","$q","AuthToken",function(e,t,r){var i={};return i.login=function(t,i){return e.post("/api/authenticate",{username:t,password:i}).success(function(e){return r.setToken(e.token),e})},i.logout=function(){r.setToken()},i.isLoggedIn=function(){return r.getToken()?!0:!1},i.getUser=function(){return r.getToken()?e.get("/api/me",{cache:!0}):t.reject({message:"User has no token."})},i}]).factory("AuthToken",["$window",function(e){var t={};return t.getToken=function(){return e.localStorage.getItem("token")},t.setToken=function(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")},t}]).factory("AuthInterceptor",["$q","$location","AuthToken",function(e,t,r){var i={};return i.request=function(e){var t=r.getToken();return t&&(e.headers["x-access-token"]=t),e},i.responseError=function(i){return 403==i.status&&(r.setToken(),t.path("/login")),e.reject(i)},i}]),angular.module("chimeService",[]).factory("Chime",["$http",function(e){var t={};return t.get=function(t){return e.get("/api/chimes/"+t)},t.all=function(){return e.get("/api/chimes/")},t.create=function(t){return e.post("/api/chimes/",t)},t.update=function(t,r){return e.put("/api/chimes/"+t,r)},t["delete"]=function(t){return e["delete"]("/api/chimes/"+t)},t}]),angular.module("interestedUserService",[]).factory("InterestedUser",["$http",function(e){var t={};return t.get=function(t){return e.get("/api/interested_users/"+t)},t.all=function(){return e.get("/api/interested_users/")},t.create=function(t){return e.post("/public/interested_users/",t)},t.update=function(t,r){return e.put("/api/interested_users/"+t,r)},t["delete"]=function(t){return e["delete"]("/api/interested_users/"+t)},t}]),angular.module("soundCloudService",[]).factory("SoundCloud",["$location",function(e){var t="09552849399f3a58cd8b85d8c5b1218d",r=e.protocol()+"://"+e.host()+":"+e.port(),i={};return SC.initialize({client_id:t,redirect_uri:r+"/callback"}),i.getSC=function(){return SC},i.getTrack=function(e){return SC.get("/tracks/"+e)},i.searchTracks=function(e){return SC.get("/tracks",{q:e})},i.playTrack=function(e){var t=SC.oEmbed(e,{auto_play:!0,maxheight:"70px",show_comments:!1,color:"00ECF2"});return t},i.authenticate=function(){return SC.connect(function(){SC.get("/me",function(e){alert("Hello, "+e.username)})})},i.mapToChime=function(e){return!0},i}]),angular.module("userService",[]).factory("User",["$http",function(e){var t={};return t.get=function(t){return e.get("/api/users/"+t)},t.all=function(){return e.get("/api/users/")},t.create=function(t){return e.post("/api/users/",t)},t.update=function(t,r){return e.put("/api/users/"+t,r)},t["delete"]=function(t){return e["delete"]("/api/users/"+t)},t}]);